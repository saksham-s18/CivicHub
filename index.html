<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Complaint Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-link {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #4f46e5;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .card:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Navigation Bar -->
    <nav class="bg-indigo-700 text-white shadow-md">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a onclick="showPage('home')" class="font-bold text-xl tracking-tight cursor-pointer">CivicHub</a>
            <div class="flex items-center space-x-2">
                <a onclick="showPage('home')" class="nav-link active">Home</a>
                <a onclick="showPage('about')" class="nav-link">About</a>
                <a onclick="showPage('contact')" class="nav-link">Contact</a>
            </div>
            <div id="auth-links" class="flex items-center space-x-2">
                <a onclick="showPage('auth')" class="nav-link bg-indigo-500 hover:bg-indigo-600">Login / Register</a>
            </div>
             <div id="user-info" class="hidden items-center space-x-4">
                <span id="username-display" class="font-semibold"></span>
                <button onclick="handleLogout()" class="nav-link bg-red-500 hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Home Page -->
        <div id="home" class="page active">
             <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Voice Your Concerns</h1>
                <p class="text-gray-600 mt-2">Submit, vote, and track civic issues to build a better community.</p>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div id="form-container" class="card p-6">
                        <!-- Content will be login prompt or form -->
                    </div>
                     <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-3 flex items-center"><i data-lucide="award" class="mr-2"></i>Most Voted Complaint</h3>
                        <div id="most-voted-complaint" class="text-gray-600">No pending complaints.</div>
                    </div>
                </div>
                <div class="lg:col-span-2 card p-6">
                     <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Community Complaints</h2>
                     <div id="complaints-list" class="space-y-4"></div>
                </div>
            </main>
        </div>

        <!-- About Page -->
        <div id="about" class="page max-w-4xl mx-auto">
             <h1 class="text-4xl font-bold mb-4">About CivicHub</h1>
             <p class="text-lg text-gray-700 leading-relaxed">CivicHub is a community-driven platform designed to empower citizens. Our mission is to provide a transparent and efficient way for people to report local issues, from potholes and broken streetlights to waste management problems. By allowing users to upvote complaints, we help local authorities prioritize the most pressing issues identified by the community itself. This project demonstrates the power of data structures like priority queues (for ranking) and hash maps (for efficient data handling) to solve real-world problems.</p>
        </div>

        <!-- Contact Page -->
        <div id="contact" class="page max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold mb-4">Contact Us</h1>
            <p class="text-lg text-gray-700 leading-relaxed">Have questions or feedback? We'd love to hear from you. Reach out to our team at <a href="mailto:contact@civichub.example" class="text-indigo-600 hover:underline">contact@civichub.example</a>. We are committed to continuously improving this platform to better serve our communities.</p>
        </div>

        <!-- Auth Page (Login/Register) -->
        <div id="auth" class="page max-w-md mx-auto">
             <div class="card p-8">
                <!-- Tabs -->
                <div class="flex border-b mb-6">
                    <button id="login-tab" onclick="switchAuthTab('login')" class="flex-1 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">Login</button>
                    <button id="register-tab" onclick="switchAuthTab('register')" class="flex-1 py-2 font-semibold text-gray-500">Register</button>
                </div>
                <!-- Forms -->
                <form id="login-form" class="space-y-4">
                    <h2 class="text-2xl font-bold text-center">Welcome Back!</h2>
                     <div>
                        <label for="login-username" class="block text-sm font-medium">Username</label>
                        <input type="text" id="login-username" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="login-password" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-md hover:bg-indigo-700">Login</button>
                </form>
                <form id="register-form" class="hidden space-y-4">
                     <h2 class="text-2xl font-bold text-center">Create Account</h2>
                    <div>
                        <label for="register-username" class="block text-sm font-medium">Username</label>
                        <input type="text" id="register-username" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="register-password" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-md hover:bg-indigo-700">Register</button>
                </form>
                <div id="auth-message" class="mt-4 text-center"></div>
             </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let currentUser = null;

        // --- SPA Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`a[onclick="showPage('${pageId}')"]`).classList.add('active');
        }

        function switchAuthTab(tabId) {
            if (tabId === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-tab').classList.add('text-indigo-600', 'border-indigo-600');
                document.getElementById('register-tab').classList.remove('text-indigo-600', 'border-indigo-600');
            } else {
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-tab').classList.add('text-indigo-600', 'border-indigo-600');
                document.getElementById('login-tab').classList.remove('text-indigo-600', 'border-indigo-600');
            }
        }

        // --- UI Rendering ---
        function updateUIforAuthState() {
            if (currentUser) {
                document.getElementById('auth-links').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('username-display').textContent = `Welcome, ${currentUser.username}`;
                renderComplaintForm();
            } else {
                document.getElementById('auth-links').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                renderLoginPrompt();
            }
        }
        
        function renderLoginPrompt() {
             document.getElementById('form-container').innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">Join the Conversation</h2>
                <p>Please <a onclick="showPage('auth')" class="text-indigo-600 font-bold hover:underline cursor-pointer">login or register</a> to submit a new complaint.</p>
             `;
        }

        function renderComplaintForm() {
            document.getElementById('form-container').innerHTML = `
                <h2 class="text-2xl font-semibold mb-4">File a New Complaint</h2>
                <form id="complaint-form" class="space-y-4">
                    <textarea id="description" rows="3" required placeholder="Describe the issue..." class="w-full rounded-md p-2 border"></textarea>
                    <input type="text" id="location" required placeholder="Location (e.g., Main Street Park)" class="w-full rounded-md p-2 border">
                    <select id="category" required class="w-full rounded-md p-2 border">
                        <option>Waste Management</option><option>Roads & Traffic</option><option>Public Health</option>
                        <option>Sanitation</option><option>Water Supply</option><option>Public Safety</option>
                        <option>Infrastructure</option><option>Noise Pollution</option>
                    </select>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-md hover:bg-indigo-700">Submit Complaint</button>
                    <div id="form-message" class="mt-2 text-center"></div>
                </form>
            `;
            document.getElementById('complaint-form').addEventListener('submit', handleComplaintSubmit);
        }
        
        // --- API Calls & Event Handlers ---
        async function fetchAllData() {
            fetchComplaints();
            fetchMostVoted();
        }

        async function fetchComplaints() {
            const response = await fetch(`${API_URL}/complaints`);
            const complaints = await response.json();
            const list = document.getElementById('complaints-list');
            list.innerHTML = '';

            if (complaints.length === 0) {
                list.innerHTML = '<p>No complaints yet. Be the first to post!</p>';
                return;
            }

            complaints.forEach(c => {
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg bg-gray-50 flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <p class="font-semibold">${c.category}</p>
                        <p class="text-sm text-gray-600">${c.description}</p>
                        <p class="text-xs text-gray-500 mt-1">@ ${c.location}</p>
                         <span class="inline-block mt-2 px-2 py-1 text-xs rounded-full ${c.status === 'Resolved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${c.status}</span>
                    </div>
                    <div class="text-center">
                        <button onclick="handleUpvote('${c.id}')" ${!currentUser ? 'disabled' : ''} class="flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-full hover:bg-indigo-200 disabled:cursor-not-allowed">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                            <span class="font-bold text-lg">${c.upvotes}</span>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons(); // Re-render icons
        }

        async function fetchMostVoted() {
            const response = await fetch(`${API_URL}/complaints/most_voted`);
            const complaint = await response.json();
            const el = document.getElementById('most-voted-complaint');
            if (complaint) {
                el.innerHTML = `<strong>(${complaint.upvotes} votes) ${complaint.category}:</strong> ${complaint.description}`;
            } else {
                el.textContent = 'No pending complaints.';
            }
        }
        
        async function handleUpvote(id) {
            await fetch(`${API_URL}/complaint/${id}/upvote`, { method: 'POST' });
            fetchAllData();
        }

        async function handleComplaintSubmit(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('form-message');
            const complaint = {
                description: document.getElementById('description').value,
                location: document.getElementById('location').value,
                category: document.getElementById('category').value,
                owner_id: currentUser.id
            };
            
            const response = await fetch(`${API_URL}/complaint`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(complaint)
            });

            if (response.ok) {
                messageDiv.textContent = 'Submitted!';
                messageDiv.className = 'text-green-600';
                e.target.reset();
                fetchAllData();
            } else {
                 messageDiv.textContent = 'Submission failed.';
                 messageDiv.className = 'text-red-600';
            }
        }
        
        // --- Authentication Logic ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const messageDiv = document.getElementById('auth-message');
            
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const user = await response.json();
                if (!response.ok) throw new Error(user.detail);

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                updateUIforAuthState();
                showPage('home');
            } catch(error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'text-red-500';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const messageDiv = document.getElementById('auth-message');

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const user = await response.json();
                if (!response.ok) throw new Error(user.detail);
                
                messageDiv.textContent = 'Registration successful! Please log in.';
                messageDiv.className = 'text-green-500';
                switchAuthTab('login');
                e.target.reset();
            } catch(error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'text-red-500';
            }
        });

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUIforAuthState();
            fetchAllData();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
            updateUIforAuthState();
            fetchAllData();
            lucide.createIcons();
        });
    </script>
</body>
</html>

